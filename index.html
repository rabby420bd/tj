<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Tracking — Trendy Jamakapor</title>
  <style>
    :root {
      --primary: #0b74ff;
      --primary-dark: #095ecf;
      --muted: #6b7280;
      --card-bg: #fff;
      --page-bg: #f7fafc;
      --glass: rgba(255,255,255,0.6);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body {
      height: 100%;
      margin:0;
      background: var(--page-bg);
      color:#111827;
    }

    .container {
      max-width: 980px;
      margin: 28px auto;
      padding: 20px;
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
    }

    header h1 { margin:0; font-size:20px; }
    header p { margin:0; color:var(--muted); font-size:13px; }

    .card {
      background: var(--card-bg);
      border-radius:10px;
      box-shadow: 0 6px 18px rgba(16,24,40,0.06);
      padding:16px;
      margin-bottom:16px;
      border:1px solid #e6edf3;
    }

    .track-form {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .track-form input[type="text"] {
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #e6edf3;
      font-size:14px;
    }
    .btn {
      padding:9px 14px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-ghost { background:transparent; border:1px solid #e6edf3; color:#111827; }

    #track-result { margin-top:12px; }

    /* order card */
    .order {
      border:1px solid #eef2f7;
      border-radius:10px;
      padding:12px;
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .order-top { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .order-meta { color:var(--muted); font-size:13px; }
    .status-pill {
      padding:6px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
    }
    .items { font-size:14px; color:#374151; }

    .actions { display:flex; gap:8px; align-items:center; }

    /* small helper */
    .text-muted { color:var(--muted); font-size:13px; }

    /* responsive */
    @media (max-width:640px) {
      .track-form { flex-direction:column; align-items:stretch; }
      .actions { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>TRENDY JAMAKAPOR — অর্ডার ট্র্যাকিং</h1>
        <p>Order ID (উদাহরণ: <code>TJ0001</code>) অথবা ফোন নম্বর লিখে সার্চ করুন</p>
      </div>
      <div class="text-muted">Invoice: A4 (top 40% occupied)</div>
    </header>

    <div class="card">
      <form id="track-form" onsubmit="return false;">
        <div class="track-form">
          <input id="track-query" type="text" placeholder="Order ID বা Phone নম্বর লিখুন (উদাহরণ: TJ0001 বা 017XXXXXXXX)" />
          <button id="btn-track" class="btn btn-primary" onclick="handleTrackOrder(event)">Track</button>
          <button id="btn-demo" class="btn btn-ghost" onclick="loadDemoOrders()">Load Demo</button>
        </div>
        <div id="track-result" style="margin-top:12px"></div>
      </form>
    </div>

    <div id="other-info" class="card">
      <div class="text-muted">নোট: যদি আপনার প্রকল্পে Firebase/কোনো সার্ভার থাকে, নিচের <strong>FIREBASE SETUP</strong> অংশটি কনফিগার করে দিন — নচেৎ ডেমো মোডে কাজ করবে।</div>
    </div>
  </div>

  <script>
    /***********************************************
     * Helpers: copyToClipboard, formatMoney, statusColor
     ***********************************************/
    function copyToClipboard(text) {
      navigator.clipboard?.writeText(text).then(() => {
        alert('Copied: ' + text);
      }).catch(() => {
        // fallback
        const t = document.createElement('textarea');
        t.value = text;
        document.body.appendChild(t);
        t.select();
        try { document.execCommand('copy'); alert('Copied: ' + text); } catch(e){ alert('Copy failed'); }
        t.remove();
      });
    }

    function formatMoney(n) {
      return (Number(n)||0).toLocaleString();
    }

    function statusColor(status) {
      if (!status) return 'background:#e6f4ea;color:#047857';
      const s = status.toLowerCase();
      if (s.includes('deliv') || s.includes('deliver') || s.includes('ডেলিভ')) return 'background:#ecfdf5;color:#065f46';
      if (s.includes('cancel') || s.includes('cancelled') || s.includes('ক্যান্সেল')) return 'background:#fff1f2;color:#991b1b';
      return 'background:#eef2ff;color:#0b60c6';
    }

    /***********************************************************
     * FIREBASE SETUP (OPTIONAL)
     *
     * If you use Firebase, uncomment & add your config below,
     * then remove the demo fallback. Example:
     *
     * 1) Add <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
     *    and firestore scripts OR use modular SDK.
     * 2) Initialize with your firebaseConfig.
     * 3) Ensure getOrdersFromBackend uses Firestore methods.
     *
     ***********************************************************/
    // const useFirebase = false; // set true if using
    // // Example placeholder: implement according to your SDK (modular or compat)
    // function getPublicCollectionRef(name) { return null; }
    // async function getDocs(q) { return []; }
    // function query(ref, ...args) { return null; }
    // function where(field, op, value) { return null; }

    /***********************************************************
     * FALLBACK: demo/mock data
     ***********************************************************/
    const mockOrders = [
      {
        orderId: 'TJ0001',
        customerName: 'মাহফুজুর রহমান',
        phone: '01711001100',
        address: 'Dhaka, Bangladesh',
        status: 'Delivered',
        items: [
          { name: 'Old Money Zipper Sweatshirt', size: 'L', quantity: 1, price: 499 },
          { name: 'Classic Shirt', size: 'M', quantity: 2, price: 349 }
        ],
        subtotal: 499 + 2*349,
        deliveryCharge: 60,
        totalAmount: 499 + 2*349 + 60,
        timestamp: { seconds: Math.floor(Date.now()/1000) - 86400 },
        transactionId: 'TRX123456'
      },
      {
        orderId: 'TJ0002',
        customerName: 'Bijoy Krishna Dey',
        phone: '01711001100',
        address: 'Volai, Bhola',
        status: 'On the way',
        items: [
          { name: 'Premium Sweater', size: 'M', quantity: 1, price: 899 }
        ],
        subtotal: 899,
        deliveryCharge: 70,
        totalAmount: 969,
        timestamp: { seconds: Math.floor(Date.now()/1000) - 3600 * 5 },
        transactionId: 'TRX654321'
      },
      {
        orderId: 'TJ0003',
        customerName: 'Rabby',
        phone: '01822223333',
        address: 'Gulshan, Dhaka',
        status: 'Cancelled',
        items: [
          { name: 'T-Shirt Classic', size: 'L', quantity: 3, price: 199 }
        ],
        subtotal: 597,
        deliveryCharge: 50,
        totalAmount: 647,
        timestamp: { seconds: Math.floor(Date.now()/1000) - 3600 * 24 * 3 },
        transactionId: null
      }
    ];

    // Use this to simulate a backend query: search by orderId (case-insensitive) or phone
    async function getOrdersFromBackend(queryValue) {
      // If you have Firebase/real backend, replace this function's body.
      // For now, do a local search on mockOrders:
      const q = (queryValue || '').toString().trim();
      if (!q) return [];
      const isOrderId = q.toUpperCase().startsWith('TJ');
      if (isOrderId) {
        return mockOrders.filter(o => o.orderId.toUpperCase() === q.toUpperCase());
      } else {
        return mockOrders.filter(o => (o.phone || '') === q);
      }
    }

    /***********************************************************
     * Core: handleTrackOrder & render logic
     ***********************************************************/
    async function handleTrackOrder(event) {
      if (event && event.preventDefault) event.preventDefault();
      const qV = document.getElementById('track-query').value.trim();
      const resultContainer = document.getElementById('track-result');
      resultContainer.innerHTML = `<div style="padding:18px;text-align:center;color:var(--muted)">Searching...</div>`;

      if (!qV) {
        resultContainer.innerHTML = `<div style="padding:12px;background:#fff8f5;border:1px solid #fde3d3;border-radius:8px;color:#b45309">অনুগ্রহ করে Order ID বা Phone লিখুন</div>`;
        return;
      }

      try {
        // Attempt backend
        const orders = await getOrdersFromBackend(qV);

        if (!orders || orders.length === 0) {
          resultContainer.innerHTML = `<div style="padding:12px;background:#fff2f2;border:1px solid #ffd6d6;border-radius:8px;color:#991b1b">কোনও অর্ডার পাওয়া যায়নি — তথ্য পরীক্ষা করুন।</div>`;
          return;
        }

        // sort by timestamp desc (if present)
        orders.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

        // Build HTML
        const html = orders.map(order => {
          const itemsHtml = (order.items || []).map(it => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #f1f5f9"><div>${escapeHtml(it.name)} <span style="color:var(--muted);font-size:13px">(${escapeHtml(it.size)})</span></div><div style="font-weight:700">৳${formatMoney(it.price * it.quantity)}</div></div>`).join('');
          const ts = (order.timestamp && order.timestamp.seconds) ? new Date(order.timestamp.seconds * 1000).toLocaleString() : '';
          return `
            <div class="order">
              <div class="order-top">
                <div>
                  <div style="font-weight:800;font-family:monospace">${escapeHtml(order.orderId)}</div>
                  <div class="order-meta">${ts}</div>
                </div>
                <div style="text-align:right">
                  <div style="${statusColor(order.status)}" class="status-pill">${escapeHtml(order.status || '')}</div>
                </div>
              </div>

              <div>
                <div style="font-weight:700">${escapeHtml(order.customerName || '')}</div>
                <div class="text-muted">${escapeHtml(order.phone || '')} • ${escapeHtml(order.address || '')}</div>
              </div>

              <div class="items">${itemsHtml}</div>

              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="text-muted">Subtotal: <strong>৳${formatMoney(order.subtotal)}</strong></div>
                  <div class="text-muted">Delivery: <strong>৳${formatMoney(order.deliveryCharge)}</strong></div>
                  <div style="font-size:16px;font-weight:800;margin-top:6px">Total: ৳${formatMoney(order.totalAmount)}</div>
                </div>

                <div class="actions">
                  <button class="btn btn-primary" onclick='openInvoice(${encodeURIComponent(JSON.stringify(order))})'>Download Invoice</button>
                  <button class="btn btn-ghost" onclick="copyToClipboard('${escapeJsString(order.orderId)}')">Copy ID</button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        resultContainer.innerHTML = `<div style="margin-bottom:8px;color:var(--muted);font-size:13px">Found ${orders.length} order(s). Showing most recent first.</div>${html}`;

      } catch (err) {
        console.error('Track Error', err);
        resultContainer.innerHTML = `<div style="padding:12px;background:#fff8f5;border:1px solid #fde3d3;border-radius:8px;color:#b45309">সিস্টেম ত্রুটি হয়েছে। পরে আবার চেষ্টা করুন।</div>`;
      }
    }

    /***********************************************************
     * Invoice generator: creates an A4 page where the invoice block
     * occupies top 40% of the page. Opens new tab and triggers print().
     ***********************************************************/
    function openInvoice(orderDataEncoded) {
      // decode & parse
      let order = typeof orderDataEncoded === 'string' ? JSON.parse(decodeURIComponent(orderDataEncoded)) : orderDataEncoded;

      // Build invoice HTML
      const invoiceHtml = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Invoice - ${escapeHtml(order.orderId || '')}</title>
  <style>
    @page { size: A4; margin: 10mm; }
    html,body { height:297mm; margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#111827; }
    body { padding:0; margin:0; box-sizing:border-box; }

    /* whole page container */
    .page { height:297mm; width:210mm; position:relative; background:#fff; display:flex; flex-direction:column; }

    /* invoice block occupying top 40% of A4 */
    .invoice {
      height: calc(297mm * 0.40);
      box-sizing: border-box;
      padding: 12mm;
      border-bottom: 1px solid #e6edf3;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }

    .brand { display:flex; justify-content:space-between; align-items:flex-start; }
    .brand h1 { margin:0; font-size:20px; letter-spacing:0.02em; }
    .meta { text-align:right; font-size:12px; color:#374151; }

    .items table { width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
    .items th, .items td { text-align:left; padding:6px 8px; border-bottom:1px dashed #e5e7eb; }
    .items th { text-align:left; font-weight:700; font-size:12px; color:#111827; }

    .total { margin-top:8px; text-align:right; font-weight:700; font-size:14px; }

    .below { padding:6px 12mm; font-size:11px; color:#6b7280; }

    @media print {
      body { margin:0; }
      .invoice { padding: 6mm; border-bottom: none; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="invoice">
      <div class="brand">
        <div>
          <h1>TRENDY JAMAKAPOR</h1>
          <div style="font-size:12px;color:#6b7280;">Premium men's fashion</div>
        </div>
        <div class="meta">
          <div>Invoice: <strong>${escapeHtml(order.orderId || '')}</strong></div>
          <div>${(order.timestamp && order.timestamp.seconds) ? new Date(order.timestamp.seconds * 1000).toLocaleString() : ''}</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:13px;">
        <div>
          <div style="font-weight:700">Billed To</div>
          <div>${escapeHtml(order.customerName || '')}</div>
          <div style="font-size:12px;color:#6b7280;">${escapeHtml(order.address || '')}</div>
          <div style="font-size:12px;color:#6b7280;">${escapeHtml(order.phone || '')}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700">Payment</div>
          <div style="font-size:13px;color:#111827;">TrxID: ${escapeHtml(order.transactionId || '-')}</div>
        </div>
      </div>

      <div class="items">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th style="width:60px;text-align:right">Qty</th>
              <th style="width:110px;text-align:right">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${ (order.items || []).map(i => `<tr><td>${escapeHtml(i.name)} <span style="color:#6b7280;font-size:12px">(${escapeHtml(i.size)})</span></td><td style="text-align:right">${escapeHtml(i.quantity)}</td><td style="text-align:right">৳${formatMoney(i.price * i.quantity)}</td></tr>`).join('') }
          </tbody>
        </table>
      </div>

      <div class="total">
        Subtotal: ৳${formatMoney(order.subtotal || 0)} &nbsp;&nbsp; Delivery: ৳${formatMoney(order.deliveryCharge || 0)}
        <div style="font-size:16px;margin-top:6px;">Total: ৳${formatMoney(order.totalAmount || 0)}</div>
      </div>
    </div>

    <div class="below">
      Thank you for shopping with Trendy Jamakapor. This invoice summary is generated for customer convenience.
    </div>
  </div>

  <script>
    // small delay ensures fonts/rendering before print
    setTimeout(() => {
      window.print();
      // leave window open so user can save or close manually
    }, 300);
  </script>
</body>
</html>
      `;

      const w = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=900,height=1100');
      if (!w) {
        alert('Popup blocked. Allow popups for this site to download invoice.');
        return;
      }
      w.document.open();
      w.document.write(invoiceHtml);
      w.document.close();
    }

    /***********************************************************
     * Utilities: simple escaping helpers
     ***********************************************************/
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeJsString(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\r/g,'\\r');
    }

    /***********************************************************
     * Demo helper: populate demo query & track
     ***********************************************************/
    function loadDemoOrders() {
      document.getElementById('track-query').value = '01711001100';
      handleTrackOrder();
    }

    // allow Enter to trigger search
    document.getElementById('track-query').addEventListener('keyup', function(e){
      if (e.key === 'Enter') handleTrackOrder();
    });
  </script>
</body>
</html>
