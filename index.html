<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trendy Jamakapor - Fashion E-commerce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8a3324; /* Deep Burgundy/Red for fashion brand */
            --secondary: #fce7f3; /* Light Pink */
            --text-dark: #1f2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: var(--text-dark);
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #6d251a;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .admin-link {
            cursor: pointer;
            color: var(--primary);
            text-decoration: underline;
        }
        .view-hidden { display: none; }
        .product-card, .admin-card, .checkout-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        /* Custom scrollbar for gallery */
        .image-gallery::-webkit-scrollbar {
            display: none; /* Hide scrollbar for WebKit browsers */
        }
        .image-gallery {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>

    <!-- Firebase SDK Imports and Initialization -->
    <script type="module">
        // --- SDK VERSION CHANGED TO 10.5.0 FOR STABILITY ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        
        // Use Debug level for better visibility during development
        setLogLevel('Debug');

        // ====================================================================================
        // --- VERCEL DEPLOYMENT CONFIGURATION ---
        
        const firebaseConfig = {
            apiKey: "AIzaSyBPM0unGvJC14lG85nmGmLC1X58521-o-s",
            authDomain: "trendy-jamakapor.firebaseapp.com",
            projectId: "trendy-jamakapor",
            storageBucket: "trendy-jamakapor.firebasestorage.app",
            messagingSenderId: "154302367160",
            appId: "1:154302367160:web:ee0f6064ef82952ff6bb4d",
            measurementId: "G-PFW70YB09X" 
        };
        
        // This MUST match the path used in your Firestore Security Rules (Part 1, Step 3).
        const appId = 'trendy-jamakapor-vercel'; 

        // --- GLOBAL ADMIN EMAIL CONSTANT ---
        const ADMIN_EMAIL = 'rabby420bd@gmail.com'; 
        // ====================================================================================


        let app, db, auth, userId = null;
        let isAuthReady = false;
        let products = {};
        let currentProduct = null;
        let currentCart = {}; // {productId: {name, price, size, quantity, stockMap}}
        let allOrders = [];

        // --- Utility Functions ---

        // Display custom modal/message box (instead of alert/confirm)
        window.showMessage = (title, message, isError = false) => {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const header = document.getElementById('modal-header');
            if (isError) {
                header.classList.remove('bg-green-500');
                header.classList.add('bg-red-500');
            } else {
                header.classList.remove('bg-red-500');
                header.classList.add('bg-green-500');
            }
            modal.classList.remove('hidden');
        };

        window.showView = (viewId) => {
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('view-hidden');
            });
            document.getElementById(viewId).classList.remove('view-hidden');
            window.scrollTo(0, 0); // Scroll to top on view change
        };

        // --- Firebase Initialization and Authentication ---

        const initFirebase = async () => {
            try {
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth State Changed. User ID:", userId);

                        if (!isAuthReady) {
                            // First time sign-in check
                            isAuthReady = true;
                            // Set up public data listeners
                            setupPublicDataListeners();
                            if(document.getElementById('admin-view').classList.contains('view-hidden')) {
                                showView('home-view'); // Default view
                            }
                        }
                    } else {
                        userId = null;
                        if (!isAuthReady) {
                             // Handle initial sign-in for anonymous user (no custom token needed on Vercel)
                            await signInAnonymously(auth);
                        } else {
                            // User logged out
                            isAuthReady = true;
                            showView('home-view');
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // The error message is customized to check if the user enabled Anonymous Auth
                let errorMessage = "Failed to initialize the application. Please check console for details.";
                if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "Authentication Error: Anonymous sign-in is not enabled. Please enable 'Anonymous' provider in your Firebase Authentication settings.";
                }
                showMessage("Setup Error", errorMessage, true);
            }
        };

        // --- Firestore Listeners (Public Data) ---
        // Path uses the fixed 'appId' for Vercel: /artifacts/trendy-jamakapor-vercel/public/data/{collection}
        const getPublicCollectionRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

        const setupPublicDataListeners = () => {
            // 1. Products Listener
            const productsQuery = query(getPublicCollectionRef('products'));
            onSnapshot(productsQuery, (snapshot) => {
                products = {};
                snapshot.forEach(doc => {
                    products[doc.id] = { id: doc.id, ...doc.data() };
                });
                console.log("Products updated:", Object.keys(products).length, "items.");
                renderProducts(); // Update Home View
                // If on product page, re-render
                if (currentProduct) {
                    currentProduct = products[currentProduct.id];
                    if (currentProduct) showProductDetail(currentProduct.id);
                }
            }, (error) => console.error("Error fetching products:", error));

            // 2. Orders Listener (Only relevant for Admin)
            const ordersQuery = query(getPublicCollectionRef('orders'));
            onSnapshot(ordersQuery, (snapshot) => {
                allOrders = [];
                snapshot.forEach(doc => {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });
                allOrders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                console.log("Orders updated:", allOrders.length, "orders.");
                renderAdminOrders(); // Update Admin View if active
            }, (error) => console.error("Error fetching orders:", error));
        };

        // --- Home View Logic ---

        window.renderProducts = () => {
            const container = document.getElementById('product-list');
            if (!container) return;

            if (Object.keys(products).length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-12 col-span-full">No products found. ${auth.currentUser?.email ? 'Go to Admin Panel to add some!' : 'Check back later!'}</p>`;
                return;
            }

            container.innerHTML = Object.values(products).map(p => `
                <div class="product-card flex flex-col cursor-pointer hover:shadow-xl transition duration-300" onclick="showProductDetail('${p.id}')">
                    <img src="${p.images?.[0] || 'https://placehold.co/400x500/fce7f3/8a3324?text=Trendy+Item'}"
                         alt="${p.name}" class="w-full h-64 object-cover rounded-t-lg mb-4">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold truncate mb-1">${p.name}</h3>
                        <p class="text-xl font-bold text-gray-800">BDT ${p.price.toLocaleString('en-US')}</p>
                    </div>
                    <button class="mt-4 w-full py-2 btn-primary rounded-lg text-sm">View Details</button>
                </div>
            `).join('');
        };

        // --- Product Detail View Logic ---

        window.showProductDetail = (productId) => {
            const p = products[productId];
            if (!p) {
                showMessage("Error", "Product not found.", true);
                showView('home-view');
                return;
            }
            currentProduct = p;
            
            const view = document.getElementById('product-view');
            
            // Generate Size Options
            const sizes = Object.keys(p.stock || {}).filter(size => p.stock[size] > 0);
            const sizeOptions = sizes.length > 0 ? sizes.map(size => `
                <label class="inline-flex items-center mr-4 mb-2">
                    <input type="radio" name="productSize" value="${size}"
                           class="form-radio h-4 w-4 text-pink-600 focus:ring-var(--primary)" required>
                    <span class="ml-2 text-sm font-medium border border-gray-300 rounded-lg px-3 py-1 hover:bg-gray-50 transition duration-150">${size}</span>
                </label>
            `).join('') : '<p class="text-red-500 font-semibold">Out of Stock</p>';

            // Generate Image Gallery
            const galleryHtml = (p.images || []).map((imgUrl, index) => `
                <img src="${imgUrl}" alt="${p.name} Image ${index + 1}" class="w-24 h-24 object-cover rounded-md cursor-pointer hover:opacity-80 transition duration-200"
                     onclick="document.getElementById('main-product-image').src = this.src;">
            `).join('');


            view.innerHTML = `
                <div class="max-w-4xl mx-auto product-card">
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Image Gallery -->
                        <div>
                            <img id="main-product-image" src="${p.images?.[0] || 'https://placehold.co/600x800/fce7f3/8a3324?text=Trendy+Item'}"
                                 alt="${p.name}" class="w-full h-auto object-cover rounded-lg shadow-lg mb-4">
                            <div class="image-gallery flex overflow-x-auto space-x-2 pb-2">
                                ${galleryHtml}
                            </div>
                        </div>

                        <!-- Product Details -->
                        <div>
                            <h1 class="text-3xl font-extrabold text-var(--text-dark) mb-2">${p.name}</h1>
                            <p class="text-4xl font-black text-red-600 mb-6">BDT ${p.price.toLocaleString('en-US')}</p>
                            
                            <h2 class="text-lg font-bold mb-2">Description</h2>
                            <p class="text-gray-600 mb-6 whitespace-pre-wrap">${p.description}</p>
                            
                            <form id="product-purchase-form" onsubmit="event.preventDefault(); handleBuyNow()">
                                <h2 class="text-lg font-bold mb-2">Select Size:</h2>
                                <div class="mb-6" id="size-options-container">
                                    ${sizeOptions}
                                </div>
                                
                                <label for="quantity" class="block text-lg font-bold mb-2">Quantity:</label>
                                <input type="number" id="quantity" value="1" min="1" max="10" required
                                       class="mb-8 w-24 p-2 border border-gray-300 rounded-lg focus:ring-var(--primary) focus:border-var(--primary)">
                                
                                <button type="submit" ${sizes.length === 0 ? 'disabled' : ''}
                                        class="w-full py-3 btn-primary font-semibold text-lg rounded-lg ${sizes.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                                    Buy Now
                                </button>
                                <button type="button" onclick="showView('home-view')"
                                        class="w-full mt-4 py-3 bg-gray-200 text-gray-700 font-semibold text-lg rounded-lg hover:bg-gray-300 transition duration-200">
                                    Continue Shopping
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            showView('product-view');
        };

        window.handleBuyNow = () => {
            const form = document.getElementById('product-purchase-form');
            const selectedSize = form.querySelector('input[name="productSize"]:checked')?.value;
            const quantity = parseInt(document.getElementById('quantity').value, 10);

            if (!selectedSize) {
                showMessage("Error", "Please select a size before proceeding.", true);
                return;
            }
            if (quantity <= 0 || !quantity) {
                showMessage("Error", "Quantity must be at least 1.", true);
                return;
            }
            if (currentProduct.stock[selectedSize] < quantity) {
                showMessage("Error", `Only ${currentProduct.stock[selectedSize]} units of size ${selectedSize} are available.`, true);
                return;
            }

            // Prepare a temporary cart for checkout (since the requirement is direct buy)
            currentCart = {
                [currentProduct.id]: {
                    id: currentProduct.id,
                    name: currentProduct.name,
                    price: currentProduct.price,
                    size: selectedSize,
                    quantity: quantity,
                    stockMap: currentProduct.stock,
                    image: currentProduct.images?.[0]
                }
            };
            
            renderCheckout();
        };

        // --- Checkout View Logic ---

        const DELIVERY_CHARGE = {
            'Inside Dhaka': 110,
            'Outside Dhaka': 130
        };

        window.renderCheckout = () => {
            if (Object.keys(currentCart).length === 0) {
                showMessage("Error", "Your cart is empty. Please select a product first.", true);
                showView('home-view');
                return;
            }

            const item = Object.values(currentCart)[0]; // Since 'Buy Now' only supports one item for now
            const subtotal = item.price * item.quantity;
            let deliveryCharge = 0;
            let totalAmount = subtotal;

            const cartDetails = `
                <div class="space-y-4">
                    <div class="flex items-center space-x-4 border-b pb-4">
                        <img src="${item.image || 'https://placehold.co/60x80/f0f9ff/1f2937?text=Item'}" alt="${item.name}" class="w-16 h-20 object-cover rounded-md">
                        <div class="flex-grow">
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-500">Size: ${item.size} | Qty: ${item.quantity}</p>
                        </div>
                        <p class="font-bold text-lg">BDT ${(item.price * item.quantity).toLocaleString('en-US')}</p>
                    </div>
                </div>
            `;

            const checkoutView = document.getElementById('checkout-view');
            checkoutView.innerHTML = `
                <div class="max-w-3xl mx-auto checkout-card">
                    <h1 class="text-3xl font-bold text-center text-var(--primary) mb-8">Checkout & Payment</h1>
                    
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                        ${cartDetails}
                        <div class="mt-4 pt-4 border-t border-dashed space-y-2">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span class="font-semibold">BDT ${subtotal.toLocaleString('en-US')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Delivery Charge:</span>
                                <span class="font-semibold text-red-500" id="delivery-charge-display">BDT 0</span>
                            </div>
                            <div class="flex justify-between text-2xl font-bold pt-2 border-t mt-4">
                                <span>Total Amount:</span>
                                <span class="text-var(--primary)" id="total-amount-display">BDT ${subtotal.toLocaleString('en-US')}</span>
                            </div>
                        </div>
                    </div>

                    <form id="checkout-form" onsubmit="event.preventDefault(); handleCheckoutSubmit(event)">
                        <h2 class="text-xl font-semibold mb-4">Customer Details</h2>
                        <div class="space-y-4 mb-8">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="fullName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-var(--primary) focus:border-var(--primary)">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (e.g., +8801...)</label>
                                <input type="tel" id="phone" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-var(--primary) focus:border-var(--primary)">
                            </div>
                            <div>
                                <label for="address" class="block text-sm font-medium text-gray-700">Detailed Address</label>
                                <textarea id="address" rows="3" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-var(--primary) focus:border-var(--primary)"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Location</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="location" value="Inside Dhaka" checked onchange="updateDeliveryCharge(${subtotal})" class="form-radio h-4 w-4 text-var(--primary) focus:ring-var(--primary)">
                                        <span class="ml-2">Inside Dhaka (BDT 110)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="location" value="Outside Dhaka" onchange="updateDeliveryCharge(${subtotal})" class="form-radio h-4 w-4 text-var(--primary) focus:ring-var(--primary)">
                                        <span class="ml-2">Outside Dhaka (BDT 130)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <h2 class="text-xl font-semibold mb-4">Payment Confirmation</h2>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded-lg">
                            <p class="font-bold text-yellow-800">Please send the calculated Delivery Charge to our bKash Personal Number:</p>
                            <p class="text-2xl font-extrabold text-var(--primary) my-2">01401603157</p>
                            <p class="text-sm text-yellow-800">After sending, enter the Transaction ID (Trx ID) below.</p>
                        </div>
                        
                        <div class="mb-6">
                            <label for="transactionId" class="block text-sm font-medium text-gray-700">bKash Transaction ID (Trx ID)</label>
                            <input type="text" id="transactionId" required placeholder="e.g., 8G2Y1A0B..." class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-var(--primary) focus:border-var(--primary)">
                        </div>

                        <button type="submit" class="w-full py-4 btn-primary font-bold text-xl rounded-lg">
                            Confirm Order
                        </button>
                    </form>
                </div>
            `;
            // Initialize delivery charge display
            updateDeliveryCharge(subtotal);
            showView('checkout-view');
        };

        window.updateDeliveryCharge = (subtotal) => {
            const location = document.querySelector('input[name="location"]:checked').value;
            const charge = DELIVERY_CHARGE[location];
            const total = subtotal + charge;

            document.getElementById('delivery-charge-display').textContent = `BDT ${charge.toLocaleString('en-US')}`;
            document.getElementById('total-amount-display').textContent = `BDT ${total.toLocaleString('en-US')}`;
            // Store the calculated total and charge in the form element for submission
            document.getElementById('checkout-form').dataset.deliveryCharge = charge;
            document.getElementById('checkout-form').dataset.totalAmount = total;
            document.getElementById('checkout-form').dataset.location = location;
        };

        window.handleCheckoutSubmit = async (event) => {
            const form = event.target;
            const item = Object.values(currentCart)[0];
            const deliveryCharge = parseInt(form.dataset.deliveryCharge, 10);
            const totalAmount = parseInt(form.dataset.totalAmount, 10);
            const location = form.dataset.location;

            const newOrder = {
                customerName: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                location: location,
                deliveryCharge: deliveryCharge,
                transactionId: document.getElementById('transactionId').value,
                items: [{
                    productId: item.id,
                    name: item.name,
                    size: item.size,
                    quantity: item.quantity,
                    price: item.price // price per unit
                }],
                subtotal: item.price * item.quantity,
                totalAmount: totalAmount,
                status: 'Payment Received (Pending Fulfillment)',
                timestamp: serverTimestamp(),
                customer_uid: userId 
            };

            const productsRef = getPublicCollectionRef('products');
            const productDocRef = doc(productsRef, item.id);
            
            try {
                // Use transaction to ensure stock update and order placement are atomic
                await runTransaction(db, async (transaction) => {
                    const productDoc = await transaction.get(productDocRef);
                    if (!productDoc.exists()) {
                        throw new Error("Product no longer exists in database.");
                    }
                    
                    const productData = productDoc.data();
                    const currentStock = productData.stock[item.size] || 0;
                    
                    if (currentStock < item.quantity) {
                        throw new Error(`Insufficient stock for size ${item.size}. Available: ${currentStock}`);
                    }

                    // 1. Update Stock
                    const newStock = { ...productData.stock, [item.size]: currentStock - item.quantity };
                    transaction.update(productDocRef, { stock: newStock });

                    // 2. Place Order
                    const ordersRef = getPublicCollectionRef('orders');
                    transaction.set(doc(ordersRef), newOrder); 

                    return true;
                });

                showMessage("Order Placed!", 
                    `Thank you, ${newOrder.customerName}! Your order has been confirmed. The full amount is BDT ${totalAmount.toLocaleString('en-US')}, and we have successfully verified your delivery charge payment via Trx ID: ${newOrder.transactionId}. We will contact you at ${newOrder.phone}.`,
                    false
                );
                currentCart = {}; // Clear cart
                showView('home-view');

            } catch (error) {
                console.error("Order Transaction Failed:", error);
                showMessage("Order Failed", `There was an error processing your order. This may be due to low stock or a database issue: ${error.message}`, true);
            }
        };

        // --- Admin View Logic ---

        window.handleAdminLogin = async () => {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const loginForm = document.getElementById('admin-login-form');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                if (user.email === ADMIN_EMAIL) {
                    showMessage("Success", `Welcome back, Admin!`, false);
                    loginForm.classList.add('view-hidden');
                    document.getElementById('admin-content').classList.remove('view-hidden');
                    renderAdminProducts();
                } else {
                    await signOut(auth); // Log out non-admin users immediately
                    showMessage("Access Denied", "Your account does not have administrator privileges.", true);
                }
            } catch (error) {
                console.error("Admin Login Failed:", error);
                showMessage("Login Failed", "Invalid Admin Email or Password. Remember to create this user in Firebase Auth console first.", true);
            }
        };

        window.handleAdminLogout = async () => {
            try {
                await signOut(auth);
                const loginForm = document.getElementById('admin-login-form');
                loginForm.classList.remove('view-hidden');
                document.getElementById('admin-content').classList.add('view-hidden');
                showView('home-view');
                // Re-authenticate as anonymous user
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Logout Failed:", error);
                showMessage("Error", "Could not log out properly.", true);
            }
        };
        
        window.showAdminView = () => {
            const isAdmin = auth.currentUser?.email === ADMIN_EMAIL;
            
            document.getElementById('admin-login-form').classList.toggle('view-hidden', isAdmin);
            document.getElementById('admin-content').classList.toggle('view-hidden', !isAdmin);

            if (isAdmin) {
                renderAdminProducts();
                document.getElementById('admin-email-field').textContent = auth.currentUser.email;
            }
            showView('admin-view');
        };

        // --- Admin Product Management ---

        window.renderAdminProducts = () => {
            const container = document.getElementById('admin-product-list');
            if (!container) return;
            
            let listHTML = `<div class="space-y-4">`;

            Object.values(products).forEach(p => {
                const stockSummary = Object.entries(p.stock || {}).map(([s, q]) => `${s}: ${q}`).join(', ');
                listHTML += `
                    <div class="p-4 border rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-50">
                        <div class="flex-grow">
                            <h4 class="font-bold text-lg">${p.name} <span class="text-sm text-gray-500">(ID: ${p.id.substring(0, 8)}...)</span></h4>
                            <p class="text-sm text-gray-600">Price: BDT ${p.price.toLocaleString('en-US')}</p>
                            <p class="text-sm text-gray-600">Stock: ${stockSummary || 'N/A'}</p>
                        </div>
                        <div class="flex space-x-2 mt-2 md:mt-0">
                            <button onclick="editProduct('${p.id}')" class="text-sm px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600">Edit</button>
                            <button onclick="deleteProduct('${p.id}')" class="text-sm px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `;
            });
            listHTML += `</div>`;
            container.innerHTML = listHTML;
            renderAdminOrders();
        };

        window.handleAddEditProduct = async (event) => {
            event.preventDefault();
            const form = event.target;
            const productId = form.dataset.productId;

            const name = form.name.value;
            const description = form.description.value;
            const price = parseFloat(form.price.value);
            const images = form.images.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);

            // Parse Stock/Size data from hidden field
            const stockArray = form.querySelector('[name="stockData"]').value.split('|').filter(s => s);
            const stockMap = {};
            stockArray.forEach(item => {
                const [size, qty] = item.split(':');
                if (size && !isNaN(parseInt(qty, 10))) {
                    stockMap[size.trim()] = parseInt(qty, 10);
                }
            });

            const productData = { name, description, price, images, stock: stockMap };
            const productsRef = getPublicCollectionRef('products');

            try {
                if (productId) {
                    await updateDoc(doc(productsRef, productId), productData);
                    showMessage("Success", `Product "${name}" updated successfully!`);
                } else {
                    await addDoc(productsRef, productData);
                    showMessage("Success", `Product "${name}" added successfully!`);
                }
                
                form.reset();
                setupAddEditForm(null); // Reset form for adding new
            } catch (error) {
                console.error("Product Save Error:", error);
                showMessage("Error", "Failed to save product: " + error.message, true);
            }
        };

        window.editProduct = (productId) => {
            const p = products[productId];
            if (!p) return;
            setupAddEditForm(p);
            document.getElementById('admin-tab-products').click(); // Switch to the product tab
        };

        window.deleteProduct = async (productId) => {
            if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) return;

            try {
                const productsRef = getPublicCollectionRef('products');
                await deleteDoc(doc(productsRef, productId));
                showMessage("Success", "Product deleted successfully.");
            } catch (error) {
                console.error("Delete Error:", error);
                showMessage("Error", "Failed to delete product: " + error.message, true);
            }
        };

        // --- Admin Product Form Helper (Size/Stock Management) ---

        const setupAddEditForm = (product = null) => {
            const form = document.getElementById('add-edit-product-form');
            const stockContainer = document.getElementById('stock-size-container');
            const hiddenStockInput = form.querySelector('[name="stockData"]');
            
            form.reset();
            form.dataset.productId = product?.id || '';
            document.getElementById('form-title').textContent = product ? 'Edit Product' : 'Add New Product';
            
            if (product) {
                form.name.value = product.name;
                form.description.value = product.description;
                form.price.value = product.price;
                form.images.value = product.images?.join('\n') || '';
            }

            // Function to render/update stock inputs
            const updateStockInputs = () => {
                const initialStockMap = product ? product.stock : {};
                const currentStockMap = {};
                
                // Read current values from displayed inputs
                const currentInputs = stockContainer.querySelectorAll('.stock-size-group');
                currentInputs.forEach(group => {
                    const size = group.querySelector('.size-input').value.trim();
                    const qty = parseInt(group.querySelector('.qty-input').value, 10);
                    if (size && !isNaN(qty)) {
                        currentStockMap[size] = qty;
                    }
                });

                // Use existing values or initial product values
                const mapToRender = product ? product.stock : currentStockMap;

                stockContainer.innerHTML = Object.entries(mapToRender).map(([size, qty]) => `
                    <div class="stock-size-group flex space-x-2 mb-2">
                        <input type="text" placeholder="Size (e.g., S)" value="${size}" class="size-input p-2 border border-gray-300 rounded-lg w-1/3">
                        <input type="number" placeholder="Stock Qty" value="${qty}" min="0" class="qty-input p-2 border border-gray-300 rounded-lg w-1/3">
                        <button type="button" onclick="removeStockGroup(this)" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 w-1/3">Remove</button>
                    </div>
                `).join('');

                // Add an empty row if adding a new product or if the form is empty
                if (Object.keys(mapToRender).length === 0 || !product) {
                     stockContainer.insertAdjacentHTML('beforeend', `
                        <div class="stock-size-group flex space-x-2 mb-2">
                            <input type="text" placeholder="Size (e.g., S)" class="size-input p-2 border border-gray-300 rounded-lg w-1/3">
                            <input type="number" placeholder="Stock Qty" min="0" value="0" class="qty-input p-2 border border-gray-300 rounded-lg w-1/3">
                            <button type="button" onclick="removeStockGroup(this)" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 w-1/3">Remove</button>
                        </div>
                    `);
                }
                updateHiddenStock();
            };
            
            window.addStockGroup = () => {
                stockContainer.insertAdjacentHTML('beforeend', `
                    <div class="stock-size-group flex space-x-2 mb-2">
                        <input type="text" placeholder="Size (e.g., M)" class="size-input p-2 border border-gray-300 rounded-lg w-1/3">
                        <input type="number" placeholder="Stock Qty" min="0" value="0" class="qty-input p-2 border border-gray-300 rounded-lg w-1/3">
                        <button type="button" onclick="removeStockGroup(this)" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 w-1/3">Remove</button>
                    </div>
                `);
            };

            window.removeStockGroup = (button) => {
                button.closest('.stock-size-group').remove();
                updateHiddenStock();
            };

            window.updateHiddenStock = () => {
                let stockData = [];
                stockContainer.querySelectorAll('.stock-size-group').forEach(group => {
                    const size = group.querySelector('.size-input').value.trim();
                    const qty = parseInt(group.querySelector('.qty-input').value, 10);
                    if (size && !isNaN(qty)) {
                        stockData.push(`${size}:${qty}`);
                    }
                });
                hiddenStockInput.value = stockData.join('|');
            };

            // Attach change listener to update hidden field on any input change
            stockContainer.oninput = updateHiddenStock;
            
            updateStockInputs(); // Initial render
        };

        // --- Admin Order Management ---
        window.renderAdminOrders = () => {
            const container = document.getElementById('admin-order-list');
            if (!container) return;
            
            if (allOrders.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">No orders received yet.</p>`;
                return;
            }

            container.innerHTML = allOrders.map(order => {
                const timestamp = order.timestamp?.toDate ? order.timestamp.toDate().toLocaleString() : 'N/A';
                const itemsList = order.items.map(i => `${i.name} (Size: ${i.size}, Qty: ${i.quantity})`).join('<br>');
                
                return `
                    <div class="p-4 border rounded-lg bg-white shadow-sm hover:shadow-md transition duration-200">
                        <div class="flex justify-between items-start mb-2 border-b pb-2">
                            <h4 class="font-bold text-xl text-var(--primary)">Order #${order.id.substring(0, 8)}...</h4>
                            <span class="text-sm font-semibold p-1 rounded-full ${order.status.includes('Pending') ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                ${order.status}
                            </span>
                        </div>
                        <p class="text-sm mb-1"><strong>Customer:</strong> ${order.customerName} (${order.phone})</p>
                        <p class="text-sm mb-1"><strong>Address:</strong> ${order.address}, ${order.location}</p>
                        <p class="text-sm mb-1"><strong>Trx ID:</strong> <span class="font-mono text-red-600">${order.transactionId}</span></p>
                        <p class="text-sm mb-2"><strong>Items:</strong> <br><span class="ml-4">${itemsList}</span></p>
                        <p class="text-md font-bold text-gray-700">Total: BDT ${order.totalAmount.toLocaleString('en-US')} (Delivery: ${order.deliveryCharge} BDT)</p>
                        <p class="text-xs text-gray-400 mt-2">Time: ${timestamp}</p>
                    </div>
                `;
            }).join('');
        };
        
        // --- Initialize App ---
        initFirebase();
        
    </script>

    <!-- Modal/Message Box Structure -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden">
            <div id="modal-header" class="p-4 text-white font-bold text-lg">
                <span id="modal-title">Message</span>
            </div>
            <div class="p-6">
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="w-full py-2 btn-primary rounded-lg font-semibold">Close</button>
            </div>
        </div>
    </div>


    <!-- HEADER/NAVBAR -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <div onclick="showView('home-view')" class="text-2xl font-black cursor-pointer text-var(--primary)">
                Trendy Jamakapor
            </div>
            <nav class="flex items-center space-x-4">
                <a href="tel:+8801401603157" class="text-gray-700 hover:text-var(--primary) text-sm font-medium hidden sm:inline">
                    +8801401603157
                </a>
                <span onclick="showAdminView()" class="admin-link text-sm font-medium">
                    Admin
                </span>
                <!-- Cart/Checkout Link - Placeholder, functional only via "Buy Now" -->
                <button onclick="if(Object.keys(currentCart).length > 0) { renderCheckout(); } else { showMessage('Cart Empty', 'Please select a product and use the "Buy Now" button.'); showView('home-view'); }" 
                        class="p-2 bg-var(--primary) text-white rounded-full hover:bg-red-700 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l3.24 10.8A2 2 0 0010.5 16h8a2 2 0 001.9-2.3L21.3 6H6" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a1 1 0 100-2 1 1 0 000 2zM7 21a1 1 0 100-2 1 1 0 000 2z" />
                    </svg>
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 pt-8">

        <!-- 1. HOME VIEW -->
        <div id="home-view" class="app-view">
            <h1 class="text-4xl font-extrabold text-center mb-10 text-gray-800">New Arrivals</h1>
            <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Products will be rendered here by JavaScript -->
                <p class="text-center col-span-full py-12 text-gray-500">Loading products...</p>
            </div>
        </div>

        <!-- 2. PRODUCT DETAIL VIEW -->
        <div id="product-view" class="app-view view-hidden">
            <!-- Product details and purchase form will be rendered here by JavaScript -->
        </div>

        <!-- 3. CHECKOUT VIEW -->
        <div id="checkout-view" class="app-view view-hidden">
             <!-- Checkout form will be rendered here by JavaScript -->
        </div>

        <!-- 4. ADMIN VIEW -->
        <div id="admin-view" class="app-view view-hidden">
            <h1 class="text-4xl font-extrabold text-center mb-10 text-var(--primary)">Admin Panel</h1>
            
            <!-- Admin Login Form -->
            <div id="admin-login-form" class="max-w-md mx-auto admin-card">
                <h2 class="text-2xl font-bold mb-6 text-center">Admin Sign In</h2>
                <form onsubmit="event.preventDefault(); handleAdminLogin()">
                    <div class="space-y-4">
                        <div>
                            <label for="admin-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <!-- Default value set to rabby420bd@gmail.com -->
                            <input type="email" id="admin-email" value="rabby420bd@gmail.com" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-var(--primary) focus:border-var(--primary)">
                        </div>
                        <div>
                            <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <!-- Default value set to trendy123 -->
                            <input type="password" id="admin-password" value="trendy123" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-var(--primary) focus:border-var(--primary)">
                        </div>
                        <button type="submit" class="w-full py-3 btn-primary rounded-lg font-semibold">Login</button>
                    </div>
                </form>
            </div>

            <!-- Admin Content (Product/Order Management) -->
            <div id="admin-content" class="view-hidden">
                <div class="flex justify-between items-center mb-6">
                    <p class="text-md font-medium">Logged in as: <span id="admin-email-field" class="font-bold"></span></p>
                    <button onclick="handleAdminLogout()" class="text-sm px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Logout</button>
                </div>
                
                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="admin-tab-products" onclick="switchAdminTab('products')" class="tab-button border-b-2 py-3 px-1 text-sm font-medium whitespace-nowrap border-var(--primary) text-var(--primary)">
                            Product Management
                        </button>
                        <button id="admin-tab-orders" onclick="switchAdminTab('orders')" class="tab-button border-b-2 py-3 px-1 text-sm font-medium whitespace-nowrap border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">
                            Order History
                        </button>
                    </nav>
                </div>

                <!-- Product Management Tab -->
                <div id="admin-tab-content-products" class="admin-tab-content">
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Add/Edit Form -->
                        <div class="admin-card">
                            <h2 id="form-title" class="text-2xl font-bold mb-6">Add New Product</h2>
                            <form id="add-edit-product-form" onsubmit="handleAddEditProduct(event)">
                                <input type="hidden" name="stockData" value="">

                                <div class="space-y-4">
                                    <div>
                                        <label for="name" class="block text-sm font-medium text-gray-700">Product Name</label>
                                        <input type="text" name="name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                                    </div>
                                    <div>
                                        <label for="price" class="block text-sm font-medium text-gray-700">Price (BDT)</label>
                                        <input type="number" name="price" required min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                                    </div>
                                    <div>
                                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                        <textarea name="description" rows="3" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea>
                                    </div>
                                    <div>
                                        <label for="images" class="block text-sm font-medium text-gray-700">Image URLs (One per line)</label>
                                        <textarea name="images" rows="4" placeholder="https://image1.com/product.jpg" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea>
                                    </div>
                                    
                                    <!-- Stock & Size Management -->
                                    <h3 class="text-lg font-semibold pt-2 border-t mt-4">Stock & Size Management</h3>
                                    <div id="stock-size-container">
                                        <!-- Stock inputs rendered by JS -->
                                    </div>
                                    <button type="button" onclick="addStockGroup()" class="py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">Add Size/Stock</button>
                                    
                                    <div class="flex space-x-4 pt-4">
                                        <button type="submit" class="w-full py-3 btn-primary rounded-lg font-semibold">Save Product</button>
                                        <button type="button" onclick="setupAddEditForm(null)" class="w-1/3 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">New/Clear</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Product List -->
                        <div class="admin-card">
                            <h2 class="text-2xl font-bold mb-6">Current Inventory</h2>
                            <div id="admin-product-list" class="space-y-4">
                                <!-- Product list rendered by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order History Tab -->
                <div id="admin-tab-content-orders" class="admin-tab-content view-hidden">
                    <div id="admin-order-list" class="space-y-6">
                        <!-- Order list rendered by JS -->
                    </div>
                </div>
            </div>
            <script>
                // Tab switching logic for Admin Panel
                function switchAdminTab(tabName) {
                    document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('view-hidden'));
                    document.getElementById(`admin-tab-content-${tabName}`).classList.remove('view-hidden');
                    
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('border-var(--primary)', 'text-var(--primary)');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                    });
                    
                    const activeBtn = document.getElementById(`admin-tab-${tabName}`);
                    activeBtn.classList.add('border-var(--primary)', 'text-var(--primary)');
                    activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                }
                // Initial setup for the product form
                window.onload = () => {
                    // Check if the initial function is available (it's inside the module script)
                    if (typeof setupAddEditForm === 'function') {
                        setupAddEditForm(null); 
                    }
                }
            </script>
        </div>

    </main>
    
    <!-- FOOTER -->
    <footer class="mt-12 bg-gray-800 text-white p-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center text-center md:text-left space-y-4 md:space-y-0">
            <div class="text-sm">
                <p>&copy; ${new Date().getFullYear()} Trendy Jamakapor. All rights reserved.</p>
                <p>Designed with <span class="text-red-400"></span> for Bangladesh.</p>
            </div>
            <div class="text-sm space-y-1">
                <p>Email: <a href="mailto:rabby420bd@gmail.com" class="hover:text-var(--secondary)">rabby420bd@gmail.com</a></p>
                <p>Phone: <a href="tel:+8801401603157" class="hover:text-var(--secondary)">+8801401603157</a></p>
                <p>Facebook: <a href="www.facebook.com/trendyjamakapor" target="_blank" class="hover:text-var(--secondary)">www.facebook.com/trendyjamakapor</a></p>
            </div>
        </div>
    </footer>

</body>
</html>

